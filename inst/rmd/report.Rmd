---
title: 'Forester report'
subtitle: 'version 1.0'
output:
  html_document:
    df_print: paged
date: '`r Sys.time()`'
version: 'forester 1.0'
params:
  models: NULL
  data: NULL
  y: NULL
  test_data: NULL
  train_data: NULL
  observed: NULL
  train_observed: NULL
  score: NULL
  best_models: NULL
  predictions: NULL
  metric_name: NULL
  type: 'regression'
  check_data: FALSE
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment=NA, warning = FALSE, message = FALSE)
```

This report contains details about the best trained model, table with metrics for every trained model, scatter plot for chosen metric and info about used data.

## The best models
This is the **`r params$type`** task.  
The best model is: 
**`r paste(names(params$best_models[1]), sep="' '", collapse=", ")`**.

*More details about bests models are present at the end of the report.*



```{r table}
score_frame          <- params$score
score_rounded        <- score_frame
for(i in 2:ncol(score_rounded)) {
  score_rounded[, i] <- round(as.numeric(score_rounded[, i]), 4)
}
knitr::kable(score_rounded)
```

```{r echo = FALSE}
  train_predictions <- predict_models(models      = params$models,
                                      data        = params$train_data,
                                      y           = params$y,
                                      engine      = c('ranger', 'xgboost', 'decision_tree'), # always without 'lightgbm' and 'catboost', because there are different types for train and test data
                                      type        = params$type,
                                      probability = TRUE)
  test_predictions <- predict_models(models       = params$models,
                                     data         = params$test_data,
                                     y            = params$y,
                                     engine       = c('ranger', 'xgboost', 'decision_tree'), # without 'lightgbm' and 'catboost', because in train_predictions also
                                     params$type,
                                     TRUE)
```

## Plots for all models

```{r radar_plot, out.width="50%", align = 'center'}
draw_radar_plot(params$score[1:10, ], params$type)
```



```{r plots_for_all_models, out.width="50%"}
if (params$type != 'binary_clf') {
  draw_boxplot(params$observed, params$predictions)
  
  
  draw_rmse_plot(train_predictions = train_predictions,
               train_observed      = params$train_observed,
               test_predictions    = test_predictions,
               test_observed       = params$observed)
}

```

## Plots for the best model - **`r names(params$best_models[1])`**

```{r plots_for_the_best_model, out.width="50%"}
if (params$type == 'binary_clf') {
  tryCatch(
    expr = {
      draw_roc_plot(params$best_models[1], params$test_data, params$observed)
    },
    error = function(e) {
      
    }
  )
  
  draw_confusion_matrix(params$best_models[1], params$test_data, params$observed)
} else {
  if (names(params$best_models[1]) == 'ranger_model') {
    draw_scatterplot(train_observed    = params$train_observed,
                     train_predictions = train_predictions$ranger_preds,
                     test_observed     = params$observed,
                     test_predictions  = test_predictions$ranger_preds)
  } else if (names(params$best_models[1]) == 'xgboost_model') {
    draw_scatterplot(train_observed    = params$train_observed,
                     train_predictions = train_predictions$xgboost_preds,
                     test_observed     = params$observed,
                     test_predictions  = test_predictions$xgboost_preds)
  } else if (names(params$best_models[1]) == 'decision_tree_model') {
    draw_scatterplot(train_observed    = params$train_observed,
                     train_predictions = train_predictions$decision_tree_preds,
                     test_observed     = params$observed,
                     test_predictions  = test_predictions$decision_tree_preds)
  }
  
}
```


## Feature Importance for the best model -  **`r names(params$best_models[1])`**

```{r feature_importance}
engine <- NULL
if (grepl('ranger', names(params$best_models[1]))) {
  engine <- c('ranger')
} else if (grepl('xgboost', names(params$best_models[1]))) {
  engine <- c('xgboost')
} else if (grepl('decision_tree', names(params$best_models[1]))) {
  engine <- c('decision_tree')
} else if (grepl('lightgbm', names(params$best_models[1]))) {
  engine <- c('lightgbm')
} else if (grepl('catboost', names(params$best_models[1]))) {
  engine <- c('catboost')
}
if (engine != c('catboost') && is.null(engine)) { # For catboost there is an error with DALEX::model_parts()
  explainer <- explain(model = params$best_models[1], 
                    data = params$test_data, 
                    y = params$y, 
                    engine = engine)
  graphics::plot(DALEX::model_parts(explainer = explainer[[paste0(engine, '_explainer')]]))
}
```

## Details about data
```{r check_data}
checked_data <- check_data(params$data, params$y)
```

## The best model details
```{r}
options(width = 100)
format_models_details(params$best_models[1])
```
